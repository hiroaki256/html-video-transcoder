# WebCodecs パフォーマンス最適化ガイド

このガイドでは、WebCodecsとMediaBunnyを使用した動画トランスコードのパフォーマンスを最大化するための推奨設定を説明します。

## 目次

1. [コーデック選択のガイドライン](#コーデック選択のガイドライン)
2. [ハードウェアアクセラレーション](#ハードウェアアクセラレーション)
3. [パススルーモードの活用](#パススルーモードの活用)
4. [期待される性能](#期待される性能)
5. [最適化のベストプラクティス](#最適化のベストプラクティス)

---

## コーデック選択のガイドライン

### 映像コーデック

トランスコード速度を優先する場合の推奨順：

#### 🚀 H.264 (AVC) - **最速**
- **エンコード速度**: 最速（リアルタイム処理可能）
- **ハードウェアサポート**: 最も広範囲（GPU、SoC）
- **用途**: 速度優先、広い互換性が必要な場合
- **推奨シーン**: 
  - 4K以上の高解像度
  - リアルタイム処理が必要
  - モバイル・古いデバイスでの再生

#### ⚡ VP9 - **バランス型**
- **エンコード速度**: 中速
- **圧縮効率**: H.264より約30%向上
- **ハードウェアサポート**: 中程度（主に新しいGPU）
- **用途**: WebM出力、速度と圧縮のバランス

#### 🐌 H.265 (HEVC) - **高圧縮**
- **エンコード速度**: 遅い（H.264の2-3倍時間）
- **圧縮効率**: H.264より25-30%向上
- **ハードウェアサポート**: 中程度（新しいデバイス）
- **用途**: ファイルサイズ優先、処理時間に余裕がある場合
- **注意**: ブラウザサポートが限定的（Safari、Edgeなど）

#### 🦥 AV1 - **最高圧縮**
- **エンコード速度**: 最も遅い（H.264の3-5倍時間）
- **圧縮効率**: 最高（H.264より40-50%向上）
- **ハードウェアサポート**: 限定的（最新GPU）
- **用途**: 最小ファイルサイズ、処理時間は二の次
- **注意**: エンコード時間が非常に長い

### 音声コーデック

#### Opus - **WebM推奨**
- **エンコード速度**: 高速
- **音質**: 優れた低ビットレート性能
- **用途**: WebM出力時

#### AAC - **MP4標準**
- **エンコード速度**: 高速
- **互換性**: 最も広い
- **用途**: MP4出力時

---

## ハードウェアアクセラレーション

### 自動適用

MediaBunnyは内部でWebCodecsを使用し、ブラウザが自動的にハードウェアアクセラレーションを適用します：

- **GPU利用**: 対応コーデック（H.264、VP9など）で自動的にGPUエンコード/デコード
- **速度向上**: ソフトウェアエンコードと比較して **3倍以上高速**
- **省電力**: CPU負荷を削減

### ブラウザ・OS別サポート状況

| コーデック | Chrome (Windows) | Chrome (Mac) | Safari (Mac) | Edge (Windows) |
|----------|------------------|--------------|--------------|----------------|
| H.264    | ✅ GPU           | ✅ GPU       | ✅ GPU       | ✅ GPU         |
| VP9      | ✅ GPU (新)      | ⚠️ 限定的    | ❌           | ✅ GPU (新)    |
| H.265    | ⚠️ 限定的        | ✅ GPU       | ✅ GPU       | ✅ GPU         |
| AV1      | ⚠️ GPU (最新)    | ❌           | ❌           | ⚠️ GPU (最新)  |

> **注**: ハードウェアサポートはGPU/ドライバーのバージョンに依存します

### 確認方法

ブラウザの開発者ツールで確認：

1. **Chrome DevTools** → **Performance** タブ
2. 変換中にプロファイリング
3. **GPU Activity** セクションで GPU使用率を確認
4. `VideoEncode` / `VideoDecode` タスクが GPU で実行されているか確認

---

## パススルーモードの活用

### 最速の処理方法

**パススルーモード**は再エンコードを行わず、ストリームをそのままコピーするため、**最速**の処理が可能です。

#### 有効条件

以下の条件を満たすとパススルーモードが自動適用されます：

1. ビットレートスライダーが「現在のビットレートを維持」位置（最大値）
2. 出力コーデックと入力コーデックが一致

#### 速度比較

| モード | 処理時間（例：10分の4K動画） |
|--------|------------------------------|
| パススルー | **10-30秒**（コンテナ再マルチプレクスのみ） |
| H.264トランスコード | 5-15分（ハードウェア有） |
| AV1トランスコード | 30-60分（ソフトウェア） |

#### 推奨ワークフロー

1. **コンテナのみ変更**: MP4 ↔ WebM
   - パススルーモードで超高速変換
   
2. **ビットレート削減が必要な場合のみトランスコード**:
   - ファイルサイズを削減したい場合
   - 解像度を変更したい場合

---

## 期待される性能

### リアルタイム処理の目安

「リアルタイム」とは、10分の動画を10分以内（またはそれ以下）で処理できることを意味します。

#### H.264（ハードウェアアクセラレーション有効時）

| 解像度 | 期待速度 | 例 |
|--------|----------|-----|
| 1080p (FHD) | 2-4倍速 | 10分 → 2.5-5分 |
| 4K (UHD) | 1-2倍速 | 10分 → 5-10分 |
| 8K | 0.5-1倍速 | 10分 → 10-20分 |

#### H.265 / AV1

- **H.265**: H.264の **0.3-0.5倍速**（3-5倍時間）
- **AV1**: H.264の **0.2-0.3倍速**（5-10倍時間）

### 影響要因

実際の速度は以下に依存：

- **GPU性能**: 専用GPUの方が内蔵GPUより高速
- **CPUコア数**: マルチコア活用で高速化
- **ビットレート**: 高ビットレートほど処理負荷増
- **解像度**: 4Kは1080pの4倍のピクセル数

---

## 最適化のベストプラクティス

### 1. 可能な限りパススルーを使用

```
❌ 悪い例: 常にトランスコード
H.264 (5Mbps) → H.264 (5Mbps)
→ 処理時間: 10分（無駄な再エンコード）

✅ 良い例: パススルーモード
H.264 (5Mbps) → H.264 (5Mbps)
→ 処理時間: 20秒（ストリームコピー）
```

### 2. コーデック選択は目的に応じて

**速度優先**: H.264を選択
```javascript
// 設定例
videoCodec: 'h264'
videoBitrate: 3000000 (3Mbps)
```

**サイズ優先**: AV1を選択（時間に余裕がある場合）
```javascript
// 設定例
videoCodec: 'av1'
videoBitrate: 1500000 (1.5Mbps)
```

### 3. 不必要に高いビットレートを避ける

```
❌ 1080p動画に20Mbpsは過剰
✅ 1080p動画には3-5Mbpsで十分
```

推奨ビットレート：
- **1080p**: 3-5 Mbps (H.264)、2-3 Mbps (H.265/AV1)
- **4K**: 15-25 Mbps (H.264)、10-15 Mbps (H.265/AV1)

### 4. 音声のみ抽出

映像が不要な場合：

1. 「音声のみ抽出」トグルを有効化
2. 映像処理をスキップして大幅に高速化

### 5. バッチ処理の考慮

複数ファイルを変換する場合：

- ブラウザタブを複数開いて並列処理
- ただし、GPUリソースは共有されるため、2-3タブが最適

---

## WebCodecs技術的詳細

### ゼロコピー転送

WebCodecsは`VideoFrame`オブジェクトを**Transferable**として扱い、Worker間でGPUメモリを直接共有：

- **従来**: ピクセルデータをコピー（遅い）
- **WebCodecs**: GPUメモリへの参照を転送（超高速）

MediaBunnyはこの最適化を内部で自動実行しています。

### 内部処理パイプライン

```
[Input] → [Demux] → [Decode] → [Process] → [Encode] → [Mux] → [Output]
          ↑                                              ↑
     MediaBunny自動処理                            MediaBunny自動処理
```

パススルー時：
```
[Input] → [Demux] → [Stream Copy] → [Mux] → [Output]
          ↑                            ↑
          デコード/エンコードをスキップ（超高速）
```

---

## トラブルシューティング

### 処理が遅い場合

1. **パススルーモードを確認**
   - コンソールログで `Passthrough mode enabled` を確認
   
2. **ハードウェアアクセラレーションの確認**
   - Chrome: `chrome://gpu` で状態確認
   - Safari: 設定で「ハードウェアアクセラレーション」有効化

3. **コーデック変更**
   - H.265/AV1 → H.264に変更して速度向上

### メモリ不足エラー

- 大きなファイル（例：8K、60分以上）は分割処理を推奨
- ブラウザのメモリ制限に注意

---

## まとめ

### 速度最適化チェックリスト

- ✅ コンテナのみ変更の場合はパススルーモード使用
- ✅ 速度優先ならH.264選択
- ✅ ビットレートは必要最小限に
- ✅ ハードウェアアクセラレーション対応ブラウザ使用
- ✅ 不要な映像処理は「音声のみ」で回避

これらのベストプラクティスを適用することで、WebCodecsの真の性能を引き出し、**3倍以上の高速化**を実現できます！
