# **WebCodec Transcoder 設計書**

## **1. 概要**

本アプリケーションは、ブラウザのWebCodecs APIと外部ライブラリ **MediaBunny** を利用し、動画ファイルの再エンコードおよびコンテナ変換を行うWebトランスコーダーです。

v2.0 改定の主要な変更点:
ユーザーが動画および音声のビットレートを「現在のビットレートを維持」に設定した場合、再エンコードをスキップし、元のストリームデータをデコード/エンコードプロセスを経ずに直接出力コンテナにコピーする「パススルー（ストリームコピー）処理」を導入しました。これにより、処理速度の劇的な向上と画質・音質の完全な維持を実現します。

## **2. システム構成**

| 要素 | 技術/ライブラリ | 役割 |
| :---- | :---- | :---- |
| フロントエンド | HTML, Tailwind CSS, JavaScript | UI表示、ファイル選択、設定管理 |
| 処理コア | Web Worker | メインスレッドからの分離、トランスコード実行 |
| 動画処理エンジン | **MediaBunny** | 入力解析、デコード/エンコード制御、Muxing |
| エンコーダ/デコーダ | WebCodecs API | MediaBunny内部で使用される低レベルAPI |

## **3. 処理フロー**

### **3.1. ファイル解析 (inspectFile)**

1.  ユーザーがファイルをドロップ/選択。
2.  Web Workerにファイルを渡し、`MediaBunny.Input` で初期化。
3.  `input.getTracks()` と `input.computeDuration()` でメタデータを取得。
4.  `computePacketStats()` 等を用いてビットレートやFPSを推定。
5.  解析結果 (analysis_result) をメインスレッドに返却。
6.  UIが設定領域を有効化し、元のビットレートを基準にスライダーの最大値を設定。

### **3.2. トランスコード/パススルー実行 (startTranscode)**

1.  ユーザーが「変換開始」をクリック。
2.  Web Workerにファイルと出力設定（コーデック、ビットレート、フォーマット、音声のみフラグ）を送信。
3.  `MediaBunny.Input` と `MediaBunny.Output` を初期化。
4.  **パススルー判定**: 設定に基づき、MediaBunnyの `conversionOptions` を構築。
5.  `MediaBunny.Conversion.init()` で変換処理を初期化し、`execute()` で実行。
6.  処理完了後、出力バッファからBlobを作成し、メインスレッドに返却 (complete)。

## **4. パススルー判定ロジック**

`worker.js` 内で、映像および音声ストリームごとにパススルー（ストリームコピー）を行うか、再エンコードを行うかを判定し、MediaBunnyへのオプション設定を制御します。

| ストリーム | 判定条件 | MediaBunny設定 | 動作 |
| :---- | :---- | :---- | :---- |
| 映像 | **① ビットレート設定が「維持」（-1）** AND **② 入力と出力のコーデックが互換性を持つ** | `conversionOptions.video` を設定しない | 入力ストリームをそのまま出力へコピー (高速) |
| 音声 | **① ビットレート設定が「維持」（-1）** AND **② 入力と出力のコーデックが互換性を持つ** | `conversionOptions.audio` を設定しない | 入力ストリームをそのまま出力へコピー (高速) |

※ MediaBunnyは、明示的な変換オプションが与えられないトラックに対して、デフォルトでパススルー（コピー）を試みます。

### **互換性チェック詳細 (isCodecCompatible 関数)**

入力ファイルの元のコーデック文字列（例: avc1.42001f, mp4a.40.2）と、ユーザーの出力設定（例: h264, aac）を比較します。

| ユーザー設定 | 判定に用いる入力コーデックプレフィックス |
| :---- | :---- |
| h264 | avc1, h264 |
| h265 | hvc1, hev1 |
| av1 | av01, av1 |
| aac | mp4a, aac |
| opus | opus |

## **5. 新機能・UIロジック**

### **5.1. 音声のみ抽出 (Audio Only)**

*   **UI**: 「音声だけを抜き出す」トグルをONにすると、映像関連の設定（フォーマット、解像度、FPS、動画ビットレート）が非表示になります。
*   **処理**:
    *   出力フォーマットは音声コーデックに応じて自動選択されます（AACならMP4/m4a、OpusならWebM/opus）。
    *   Worker側では、入力トラックから映像トラックを除外し、音声トラックのみを処理対象とします。

### **5.2. スマートFPSマッチング**

*   ユーザーが指定したFPSターゲット（例: 30fps）と、ソース動画のFPS（例: 29.97fps）の差が **1.0fps未満** の場合、強制的なフレームレート変換を行わず、**ソース動画のFPSを維持**します。
*   これにより、NTSCフレームレート（29.97, 59.94など）の動画が不必要に丸められることを防ぎ、音ズレやジャダーを防止します。

### **5.3. 簡易設定モード (Simple Settings)**

*   **低 (Low)**: ビットレート 1/4 (min 1Mbps), FPS max 15, 解像度 SD
*   **中 (Medium)**: ビットレート 1/2 (min 3Mbps), FPS max 30, 解像度 HD
*   **高 (High)**: ビットレート維持 (min 6Mbps), FPS max 60, 解像度 FHD
*   **自由 (Custom)**: すべての設定を個別に変更可能

## **6. 入出力仕様**

### **6.1. 入力**

| 項目 | 詳細 |
| :---- | :---- |
| ファイル形式 | MP4, MOV (QuickTime), WebM |
| 映像コーデック | H.264, H.265, AV1, VP8, VP9 (ブラウザ/MediaBunnyが解析可能なもの) |
| 音声コーデック | AAC, Opus, MP3, PCMなど (ブラウザ/MediaBunnyが解析可能なもの) |

### **6.2. 出力**

| 項目 | 詳細 |
| :---- | :---- |
| ファイル形式 | MP4, WebM |
| 映像コーデック | H.264 (avc), H.265 (hevc), AV1 (av1) |
| 音声コーデック | AAC (mp4a.40.2), Opus |
| ビットレート | 映像: 100kbps - 10Mbps / 音声: 32kbps - 320kbps (または維持) |

## **7. エラー処理**

*   MediaBunnyによる解析エラーや変換エラーはWeb Worker内で捕捉され、メインスレッドに通知されます。
*   メインスレッドでは、画面全体を覆うカスタムモーダルでエラー内容を表示します。